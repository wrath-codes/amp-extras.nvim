{
  "$schema": "http://json-schema.org/draft-2020-12/schema",
  "$id": "https://ampcode.com/schemas/stream-json.json",
  "title": "Stream JSON Message",
  "description": "Amp --stream-json output format (Claude Code compatible)",
  "oneOf": [
    { "$ref": "#/$defs/systemInitMessage" },
    { "$ref": "#/$defs/userMessage" },
    { "$ref": "#/$defs/assistantMessage" },
    { "$ref": "#/$defs/resultMessage" }
  ],
  "$defs": {
    "mcpServer": {
      "type": "object",
      "required": ["name", "status"],
      "properties": {
        "name": {
          "type": "string"
        },
        "status": {
          "type": "string",
          "enum": ["connected", "connecting", "connection-failed", "disabled"]
        }
      }
    },
    "systemInitMessage": {
      "type": "object",
      "required": ["type", "subtype", "cwd", "session_id", "tools"],
      "properties": {
        "type": {
          "const": "system"
        },
        "subtype": {
          "const": "init"
        },
        "cwd": {
          "type": "string",
          "description": "Current working directory"
        },
        "session_id": {
          "$ref": "common.json#/$defs/sessionId"
        },
        "tools": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "mcp_servers": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/mcpServer"
          }
        }
      }
    },
    "streamUserMessage": {
      "type": "object",
      "required": ["type", "message", "session_id"],
      "properties": {
        "type": {
          "const": "user"
        },
        "message": {
          "type": "object",
          "required": ["role", "content"],
          "properties": {
            "role": {
              "const": "user"
            },
            "content": {
              "$ref": "content.json#/$defs/streamUserContent"
            }
          }
        },
        "parent_tool_use_id": {
          "type": ["string", "null"]
        },
        "session_id": {
          "$ref": "common.json#/$defs/sessionId"
        }
      }
    },
    "streamAssistantMessage": {
      "type": "object",
      "required": ["type", "message", "session_id"],
      "properties": {
        "type": {
          "const": "assistant"
        },
        "message": {
          "type": "object",
          "required": ["type", "role", "content", "stop_reason"],
          "properties": {
            "type": {
              "const": "message"
            },
            "role": {
              "const": "assistant"
            },
            "content": {
              "$ref": "content.json#/$defs/streamAssistantContent"
            },
            "stop_reason": {
              "type": ["string", "null"],
              "enum": ["end_turn", "tool_use", "max_tokens", null]
            },
            "usage": {
              "$ref": "usage.json#/$defs/streamUsage"
            }
          }
        },
        "parent_tool_use_id": {
          "type": ["string", "null"]
        },
        "session_id": {
          "$ref": "common.json#/$defs/sessionId"
        }
      }
    },
    "userMessage": {
      "$ref": "#/$defs/streamUserMessage"
    },
    "assistantMessage": {
      "$ref": "#/$defs/streamAssistantMessage"
    },
    "resultMessage": {
      "type": "object",
      "required": ["type", "subtype", "duration_ms", "is_error", "num_turns", "session_id"],
      "properties": {
        "type": {
          "const": "result"
        },
        "subtype": {
          "type": "string",
          "enum": ["success", "error_during_execution", "error_max_turns"]
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0
        },
        "is_error": {
          "type": "boolean"
        },
        "num_turns": {
          "type": "integer",
          "minimum": 0
        },
        "result": {
          "type": "string",
          "description": "Final result (present on success)"
        },
        "error": {
          "type": "string",
          "description": "Error message (present on error)"
        },
        "session_id": {
          "$ref": "common.json#/$defs/sessionId"
        },
        "usage": {
          "$ref": "usage.json#/$defs/streamUsage"
        },
        "permission_denials": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "anyOf": [
        {
          "required": ["result"],
          "not": {
            "required": ["error"]
          }
        },
        {
          "required": ["error"],
          "not": {
            "required": ["result"]
          }
        }
      ]
    }
  }
}
